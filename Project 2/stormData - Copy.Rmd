---
title: "Storm Analysis"
author: Courtney Rowlands
output: 
  html_document:
    keep_md: yes
pdf_document: default
  
---
# Storm Data Research
### Synopsis: The basic goal of this assignment is to explore the NOAA Storm Database and answer some basic questions about severe weather events. I've created an R Markdown file that will explain and graphically display the answers to the following questions: 1. Across the US, which types of events are most harmful with respect to population health, and 2. Across the US, which types of events have the greatest economic consequences?

<!-- rmarkdown v1 -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(lattice)
library(knitr)
```

## Data Processing:


```{r download, include=FALSE}
if (!file.exists("data")) {
  dir.create("data")
}

fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2" ##testdata
download.file(fileUrl,destfile="./data/repdata_data_StormData.csv.bz2")

```

```{r readData, cache=TRUE}
fStorm <- read.csv(bzfile("data/repdata_data_StormData.csv.bz2"),sep=",",header=TRUE)
str(fStorm)

```

```{r humanHealth}
stormData <- fStorm[,c("EVTYPE","FATALITIES","INJURIES")]
stormData[,1] <- as.character(stormData[,1])
totalStormData <- aggregate(stormData[,2:3],by=list(stormData$EVTYPE),FUN=sum,na.rm=T)
names(totalStormData)[1] <- "EventType"
fStormData <- totalStormData[order(-totalStormData[,2], -totalStormData[,3]), ]
head(fStormData,n=15)
```
```{r populationHealthPlot}
fStormData <- totalStormData[order(-totalStormData[,2]), ]
fStormData <- head(fStormData,n=15)
ggplot(data=fStormData,aes(x=EventType,y=log10(fStormData$INJURIES+fStormData$FATALITIES))) + 
  geom_bar(stat="identity",fill="lightblue",color="darkblue") + 
  theme(axis.text.x=element_text(angle=45,hjust=1)) + 
  labs(title="Fig. 1: Events Causing Injuries & Fatalities",y="Injuries/Fatalities (x5,000)",x="Event Type")

```

```{r}
# convert BGN_DATE string to R date Date_Bgn
Date_Bgn <- substr(fStorm$BGN_DATE,1,unlist(gregexpr(pattern=" ",fStorm$BGN_DATE))-1)
Date_Bgn <- as.Date(Date_Bgn,format="%m/%d/%Y")
# add R date vector to data frame
fStorm <- cbind(fStorm,Date_Bgn)

# tabulate count of events per year in Storm Database
eventsPerYear <- table(year(Date_Bgn))

# helper functions to trim string white space
trim.leading  <- function (x) sub("^\\s+","",x)
trim.trailing <- function (x) sub("\\s+$","",x)
trim          <- function (x) gsub("^\\s+|\\s+$","",x)

eventList <- sort(unique(trim.leading(fStorm$EVTYPE)))
```

```{r economicPROPDMGEXP}
economicPROPDMGEXP <- fStorm$PROPDMGEXP
"PropertyDmgExp" <- economicPROPDMGEXP
print(unique(economicPROPDMGEXP))
```

```{r economicCROPDMGEXP}
economicCROPDMGEXP <- fStorm$CROPDMGEXP
"CropDamageEXP" <- economicCROPDMGEXP
print(unique(economicCROPDMGEXP))

```

```{r}
# property and crop damage exponents data
exp  <- c("H", "K", "M", "B")
mult <- c(100, 1000, 1000000, 1000000000)

# sum property damages without EXP H K M B 
x <- subset(fStorm,PROPDMG > 0, select=c("PROPDMG","PROPDMGEXP"))
colnames(x) <- c("v1","v2")
indx <- which(!(toupper(x$v2)=="H")&!(toupper(x$v2)=="K")&!(toupper(x$v2)=="M")&!(toupper(x$v2)=="B"))
x <- x[indx,]
propNotHKMB <- sum(x$v1, na.rm=TRUE)
print(c("Total Property damage without H K M B PROPDMGEXP code",toString(propNotHKMB)))
```

```{r}
# sum crop damages without EXP H K M B
x <- subset(fStorm,CROPDMG > 0, select=c("CROPDMG","CROPDMGEXP"))
colnames(x) <- c("v1","v2")
indx <- which(!(toupper(x$v2)=="H")&!(toupper(x$v2)=="K")&!(toupper(x$v2)=="M")&!(toupper(x$v2)=="B"))
x <- x[indx,]
cropNotHKMB <- sum(x$v1, na.rm=TRUE)
print(c("Total Crop damage without H K M B CROPDMGEXP code",toString(cropNotHKMB)))
```